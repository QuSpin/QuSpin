
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" /><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-110543543-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>quspin.basis.basis_1d.base_1d &#8212; QuSpin 0.3.6 documentation</title>
    <link rel="stylesheet" href="../../../../static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../../" src="../../../../static/documentation_options.js"></script>
    <script src="../../../../static/jquery.js"></script>
    <script src="../../../../static/underscore.js"></script>
    <script src="../../../../static/doctools.js"></script>
    <script src="../../../../static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">QuSpin 0.3.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for quspin.basis.basis_1d.base_1d</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">..lattice</span> <span class="kn">import</span> <span class="n">lattice_basis</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_check_1d_symm</span> <span class="k">as</span> <span class="n">_check</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">_sp</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span><span class="n">cos</span><span class="p">,</span><span class="n">sin</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">pi</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span><span class="n">eigvalsh</span><span class="p">,</span><span class="n">svd</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">eigsh</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>

<span class="c1"># this is how we encode which fortran function to call when calculating </span>
<span class="c1"># the action of operator string</span>

<span class="n">_dtypes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;f&quot;</span><span class="p">:</span><span class="n">_np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">:</span><span class="n">_np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="s2">&quot;F&quot;</span><span class="p">:</span><span class="n">_np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span><span class="s2">&quot;D&quot;</span><span class="p">:</span><span class="n">_np</span><span class="o">.</span><span class="n">complex128</span><span class="p">}</span>


<span class="n">_basis_op_errors</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s2">&quot;opstr character not recognized.&quot;</span><span class="p">,</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="s2">&quot;attemping to use real hamiltonian with complex matrix elements.&quot;</span><span class="p">,</span>
				<span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="s2">&quot;index of operator not between 0 &lt;= index &lt;= L-1&quot;</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">OpstrError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
	<span class="c1"># this class defines an exception which can be raised whenever there is some sort of error which we can</span>
	<span class="c1"># see will obviously break the code. </span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">=</span><span class="n">message</span>
	<span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>

<span class="k">class</span> <span class="nc">bitops</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ops_module</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">):</span>
		<span class="k">def</span> <span class="nf">try_add</span><span class="p">(</span><span class="n">func_str</span><span class="p">,</span><span class="n">block</span><span class="p">):</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">func_str</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;module </span><span class="si">{}</span><span class="s2"> missing implementation of </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">func</span><span class="p">))</span>

		<span class="n">try_add</span><span class="p">(</span><span class="s2">&quot;py_fliplr&quot;</span><span class="p">,</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">try_add</span><span class="p">(</span><span class="s2">&quot;py_shift&quot;</span><span class="p">,</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">try_add</span><span class="p">(</span><span class="s2">&quot;py_flip_all&quot;</span><span class="p">,</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">try_add</span><span class="p">(</span><span class="s2">&quot;py_flip_sublat_A&quot;</span><span class="p">,</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">try_add</span><span class="p">(</span><span class="s2">&quot;py_flip_sublat_B&quot;</span><span class="p">,</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">basis_1d</span><span class="p">(</span><span class="n">lattice_basis</span><span class="p">):</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">basis_module</span><span class="p">,</span><span class="n">ops_module</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">count_particles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">):</span>
		<span class="n">lattice_basis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;basis_1d&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This class is not intended&quot;</span>
							 <span class="s2">&quot; to be instantiated directly.&quot;</span><span class="p">)</span>


		<span class="c1"># getting arguments which are used in basis.</span>
		<span class="n">kblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">zblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">zAblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">zBblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
		<span class="n">pblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">pzblock</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>
		<span class="n">a</span><span class="o">=</span><span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;L must be a positive integer&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid value for sps, set variable sps &gt;= 2.&quot;</span><span class="p">)</span>


		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;a must be integer&#39;</span><span class="p">)</span>

		<span class="c1"># checking if a is compatible with L</span>
		<span class="k">if</span><span class="p">(</span><span class="n">L</span><span class="o">%</span><span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;L must be interger multiple of lattice spacing a&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">pblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pblock must be +/- 1&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">zblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;zblock/sblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zblock/sblock must be +/- 1&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">zAblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;zAblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zAblock must be +/- 1&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">zBblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;zBblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zBblock must be +/- 1&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">pzblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pzblock/psblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pzblock/psblock must be +/- 1&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">kblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;kblock must be integer&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">L</span><span class="p">:</span>
				<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using momentum with L == a&quot;</span><span class="p">,</span><span class="n">stacklevel</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
			<span class="n">kblock</span> <span class="o">=</span> <span class="n">kblock</span> <span class="o">%</span> <span class="p">(</span><span class="n">L</span><span class="o">//</span><span class="n">a</span><span class="p">)</span>
			<span class="n">blocks</span><span class="p">[</span><span class="s2">&quot;kblock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kblock</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">kblock</span><span class="o">/</span><span class="n">L</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">L</span>
		<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">get_Ns</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">)</span> <span class="c1"># estimate how many states in H-space to preallocate memory.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">get_basis_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">)</span> <span class="c1"># get the size of the integer representation needed for this basis (uint32,uint64,object)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_pars</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_bitops</span> <span class="o">=</span> <span class="n">bitops</span><span class="p">(</span><span class="n">basis_module</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_pcon</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_herm</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns_pcon</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span> <span class="o">=</span> <span class="kc">False</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;basis_1d expects list for Np&quot;</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns_pcon</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_Ns_pcon</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">get_Ns</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">,</span><span class="o">**</span><span class="p">{})</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_check_pcon</span> <span class="o">=</span> <span class="kc">True</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Nps</span> <span class="o">=</span> <span class="n">Np</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_make_n_basis</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_basis</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span> <span class="o">=</span> <span class="kc">True</span>

		<span class="c1"># shout out if pblock and zA/zB blocks defined simultaneously</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zA and zB symmetries incompatible with parity symmetry&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span> <span class="o">=</span> <span class="n">blocks</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span> <span class="o">=</span> <span class="kc">True</span>

		<span class="k">if</span> <span class="n">count_particles</span><span class="p">:</span> 
			<span class="n">Np_list</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">Np_list</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="n">N</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

		<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; P &amp; Z&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; P &amp; Z&quot;</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">[</span><span class="s2">&quot;pzblock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pblock</span><span class="o">*</span><span class="n">zblock</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_p_z_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="c1"># if object is basis type then most likely this is for single particle stuff in which case the </span>
				<span class="c1"># normalizations need to be large ~ 1000 or more which won&#39;t fit in int8/int16.</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span> <span class="c1"># normalisation*sigma</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span> <span class="c1"># m = mp + (L+1)mz + (L+1)^2c; Anders&#39; paper</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_p_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># arguments get overwritten by ops.-_basis </span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_p_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; ZA &amp; ZB&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; ZA &amp; ZB&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">[</span><span class="s2">&quot;zblock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zAblock</span><span class="o">*</span><span class="n">zBblock</span>


			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_zA_zB_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_zA_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_zA_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>				
				
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; PZ&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; PZ&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_pz_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>			
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1">#mpz</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_pz_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pzblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_pz_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pzblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>
				
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; P&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; P&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_p_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>			
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_p_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_p_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; Z&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; Z&quot;</span>
			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_z_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>				
				
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; ZA&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; ZA&quot;</span>
			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_zA_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>			
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_zA_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_zA_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>				
				
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T &amp; ZB&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T &amp; ZB&quot;</span>
			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_zB_op</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>			
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
				<span class="n">M</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; P &amp; Z&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;P &amp; Z&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">p_z_op</span>
			
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">p_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_p_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; ZA &amp; ZB&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;ZA &amp; ZB&quot;</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">zA_zB_op</span>

			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">zA_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_zA_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; P&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">p_op</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">p_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_p_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; Z&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;Z&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">z_op</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_z_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; ZA&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;ZA&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">zA_op</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">zA_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_zA_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zAblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; ZB&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;ZB&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">zB_op</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_zB_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">zBblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>
			
		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; PZ&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot;PZ&quot;</span>
			<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">pz_op</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">pz_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">pzblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_pz_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">pzblock</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>
	
		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">+=</span> <span class="s2">&quot; &amp; T&quot;</span>
			<span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
			<span class="n">basis</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">t_op</span>
			
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
			<span class="k">else</span><span class="p">:</span>			
				<span class="n">N</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">t_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_t_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="n">kblock</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">else</span><span class="p">:</span> 
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">op</span>
				<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">basis</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">ops_module</span><span class="o">.</span><span class="n">n_op</span>
				<span class="n">basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
				<span class="n">Ns</span> <span class="o">=</span> <span class="n">basis_module</span><span class="o">.</span><span class="n">n_basis</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">Np</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">Np_list</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns</span>

		<span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">Ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">M</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">basis</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">Np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span><span class="p">:</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">basis</span><span class="p">[:</span><span class="n">Ns</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;heapsort&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">arg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">basis</span><span class="p">[:</span><span class="n">Ns</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_op_args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">]</span>

		<span class="k">elif</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">Ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">basis</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">Np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">basis</span><span class="p">[:</span><span class="n">Ns</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;heapsort&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_op_args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">]</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">Np</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">Ns</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">basis</span><span class="p">[:</span><span class="n">Ns</span><span class="p">],</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;heapsort&quot;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">Np_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Np_list</span> <span class="o">=</span> <span class="n">Np_list</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_op_args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">]</span>




	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">L</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;int: length of lattice.&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;int: number of sites the basis is constructed with.&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">_fermion_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="kc">False</span>



	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;str: information about `basis` object.&quot;&quot;&quot;</span>
		<span class="n">blocks</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="n">lat_space</span> <span class="o">=</span> <span class="s2">&quot;lattice spacing: a = </span><span class="si">{a}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">symm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">symm</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
				<span class="n">blocks</span> <span class="o">+=</span> <span class="n">symm</span><span class="o">+</span><span class="s2">&quot; = {&quot;</span><span class="o">+</span><span class="n">symm</span><span class="o">+</span><span class="s2">&quot;}, &quot;</span>

		<span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">symm</span> <span class="o">=</span> <span class="s2">&quot;no symmetry&quot;</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">symm</span> <span class="o">=</span> <span class="s2">&quot;symmetry&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">symm</span> <span class="o">=</span> <span class="s2">&quot;symmetries&quot;</span>

		<span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;1d basis for chain of length L = </span><span class="si">{0}</span><span class="s2"> containing </span><span class="si">{5}</span><span class="s2"> states </span><span class="se">\n\t</span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2"> </span><span class="se">\n\t</span><span class="s2">quantum numbers: </span><span class="si">{4}</span><span class="s2"> </span><span class="se">\n\t</span><span class="si">{3}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="n">symm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_conserved</span><span class="p">,</span><span class="n">lat_space</span><span class="p">,</span><span class="n">blocks</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">)</span>
		<span class="n">string</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span>
		<span class="k">return</span> <span class="n">string</span> 

	<span class="k">def</span> <span class="nf">_int_to_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">bracket_notation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">!=</span><span class="n">state</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;state must be integer&quot;</span><span class="p">)</span>

		<span class="n">n_space</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">))</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">//</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
			<span class="n">s_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;{:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">bits</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">left_bits</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">//</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
			<span class="n">right_bits</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">//</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

			<span class="n">str_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;{:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">left_bits</span><span class="p">]</span>
			<span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
			<span class="n">str_list</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;{:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">right_bits</span><span class="p">)</span>
			<span class="n">s_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">bracket_notation</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;|&quot;</span><span class="o">+</span><span class="n">s_str</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">s_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_state_to_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">):</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>		
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">state</span><span class="p">)])</span>

	<span class="k">def</span> <span class="nf">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="n">s</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
			<span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;s must be integer or string&quot;</span><span class="p">)</span>

		<span class="n">indx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">==</span> <span class="n">s</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;s must be representive state in basis. &quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_Op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">opstr</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">dtype</span><span class="p">):</span>

		<span class="n">indx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indx</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;length of opstr does not match length of indx&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;values in indx falls outside of system&#39;</span><span class="p">)</span>

		<span class="n">extra_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_ops</span>
		<span class="k">if</span> <span class="n">extra_ops</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unrecognized characters </span><span class="si">{}</span><span class="s2"> in operator string.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra_ops</span><span class="p">))</span>


		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[],[],[]</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_me</span><span class="p">:</span>
			<span class="n">N_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">N_op</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span>

		<span class="n">col</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_op</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
		<span class="n">row</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_op</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
		<span class="n">ME</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_op</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">ME</span><span class="p">,</span><span class="n">opstr</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_op_args</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="n">OpstrError</span><span class="p">(</span><span class="n">_basis_op_errors</span><span class="p">[</span><span class="n">error</span><span class="p">])</span>
		
		<span class="n">mask</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ME</span><span class="p">),</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ME</span><span class="p">)</span><span class="o">==</span><span class="mf">0.0</span><span class="p">))</span>
		<span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
		<span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
		<span class="n">ME</span> <span class="o">=</span> <span class="n">ME</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

		<span class="k">return</span> <span class="n">ME</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">col</span>		

	<span class="k">def</span> <span class="nf">get_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pcon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; DEPRECATED (cf `project_from`). Transforms state from symmetry-reduced basis to full (symmetry-free) basis.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		This function is :red:`deprecated`. Use `project_from()` instead (the inverse function, `project_to()`, is currently available in the `basis_general` classes only). </span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_from</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">,</span><span class="n">pcon</span><span class="o">=</span><span class="n">pcon</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">project_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pcon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Transforms state from symmetry-reduced basis to full (symmetry-free) basis.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Particularly useful when a given operation canot be carried out in the symmetry-reduced basis</span>
<span class="sd">		in a straightforward manner.</span>

<span class="sd">		Supports parallelisation to multiple states listed in the columns.</span>

<span class="sd">		Parameters</span>
<span class="sd">		-----------</span>
<span class="sd">		v0 : numpy.ndarray</span>
<span class="sd">			Contains in its columns the states in the symmetry-reduced basis.</span>
<span class="sd">		sparse : bool, optional</span>
<span class="sd">			Whether or not the output should be in sparse format. Default is `True`.</span>
<span class="sd">		pcon : bool, optional</span>
<span class="sd">			Whether or not to return the output in the particle number (magnetisation) conserving basis </span>
<span class="sd">			(useful in bosonic/single particle systems). Default is `pcon=False`.</span>

<span class="sd">		Returns</span>
<span class="sd">		--------</span>
<span class="sd">		numpy.ndarray</span>
<span class="sd">			Array containing the state `v0` in the full basis.</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>

<span class="sd">		&gt;&gt;&gt; v_full = get_vec(v0)</span>
<span class="sd">		&gt;&gt;&gt; print(v_full.shape, v0.shape)</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">if</span> <span class="n">pcon</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Optional argument pcon will be implemented in a future version. </span><span class="se">\</span>
<span class="s1">				Consider using the basis_1d.get_proj() function to construct the projector which already supports the pcon=True option.&#39;</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="s2">&quot;shape&quot;</span><span class="p">):</span>
			<span class="n">v0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>

		<span class="n">squeeze</span> <span class="o">=</span> <span class="kc">False</span>

		<span class="k">if</span> <span class="n">v0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">squeeze</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">elif</span> <span class="n">v0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
			<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;excpecting v0 to have ndim at most 2&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(([],([],[])),</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;v0 shape </span><span class="si">{0}</span><span class="s2"> not compatible with Ns=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">_sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">v0</span><span class="p">):</span> <span class="c1"># current work around for sparse states.</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proj</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>

		<span class="n">norms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_norms</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
		<span class="n">kblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">pblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">zblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">zAblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">zBblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
		<span class="n">pzblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>


		<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)):</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ind_neg</span><span class="p">,</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ind_pos</span><span class="p">,</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">del</span> <span class="n">mask</span>
			<span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">):</span>
				<span class="n">c</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">c</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">_np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ind_pos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">count</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="n">ind_neg</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">pi</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="n">r</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">_np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">_get_vec_sparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bitops</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
				<span class="k">return</span>  <span class="n">_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">_get_vec_dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bitops</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">_get_vec_dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bitops</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">get_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">pcon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Calculates transformation/projector from symmetry-reduced basis to full (symmetry-free) basis.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Particularly useful when a given operation canot be carried away in the symmetry-reduced basis</span>
<span class="sd">		in a straightforward manner.</span>

<span class="sd">		Parameters</span>
<span class="sd">		-----------</span>
<span class="sd">		dtype : &#39;type&#39;</span>
<span class="sd">			Data type (e.g. numpy.float64) to construct the projector with.</span>
<span class="sd">		sparse : bool, optional</span>
<span class="sd">			Whether or not the output should be in sparse format. Default is `True`.</span>
<span class="sd">		pcon : bool, optional</span>
<span class="sd">			Whether or not to return the projector to the particle number (magnetisation) conserving basis </span>
<span class="sd">			(useful in bosonic/single particle systems). Default is `pcon=False`.</span>
<span class="sd">		</span>
<span class="sd">		Returns</span>
<span class="sd">		--------</span>
<span class="sd">		scipy.sparse.csc_matrix</span>
<span class="sd">			Transformation/projector between the symmetry-reduced and the full basis.</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>

<span class="sd">		&gt;&gt;&gt; P = get_proj(np.float64,pcon=False)</span>
<span class="sd">		&gt;&gt;&gt; print(P.shape)</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">norms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_norms</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
		<span class="n">kblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">pblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">zblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">zAblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">zBblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
		<span class="n">pzblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>

		

		<span class="k">if</span> <span class="n">pcon</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span><span class="p">:</span>
			<span class="n">basis_pcon</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns_pcon</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_type</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_make_n_basis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Nps</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="n">basis_pcon</span><span class="p">)</span>
			<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns_pcon</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">pcon</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;pcon=True only works for basis of a single particle number sector.&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">)</span>
			<span class="n">basis_pcon</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(([],([],[])),</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>


		<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)):</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ind_neg</span><span class="p">,</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ind_pos</span><span class="p">,</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">del</span> <span class="n">mask</span>
			<span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">):</span>
				<span class="n">c</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">c</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">_np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
				<span class="k">if</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">kblock</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)):</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;symmetries give complex vector, requested dtype is not complex&quot;</span><span class="p">)</span>

			<span class="n">ind_pos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ind_neg</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
			<span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">pi</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="n">r</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
				<span class="n">_np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>





		<span class="k">return</span> <span class="n">_get_proj_sparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bitops</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">,</span><span class="n">basis_pcon</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_get_norms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dtype</span><span class="p">):</span>
		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
		<span class="n">kblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">pblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">zblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">zAblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">zBblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
		<span class="n">pzblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">nn</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="n">mm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="n">sign</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

			<span class="n">_np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>			
			
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">nn</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">nn</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mm</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

				
			<span class="n">norm</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>

			<span class="n">mask</span> <span class="o">=</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">1</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pzblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pzblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">nn</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">mm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">c</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mm</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zAblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zBblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="n">_np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">mm</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>	
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">kblock</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="ow">or</span> <span class="n">kblock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">*=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">min_scalar_type</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="n">mask</span><span class="p">],(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">sign</span> <span class="o">*=</span> <span class="mi">2</span>
			<span class="n">sign</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="n">sign</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="o">*</span><span class="n">pblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">*=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

			<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="n">mask</span><span class="p">],(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">sign</span> <span class="o">*=</span> <span class="mi">2</span>
			<span class="n">sign</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="n">sign</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>

			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="o">*</span><span class="n">pzblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			
			<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

			<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="n">mask</span><span class="p">],(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">out</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">sign</span> <span class="o">*=</span> <span class="mi">2</span>
			<span class="n">sign</span> <span class="o">-=</span> <span class="mi">1</span>

			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sign</span><span class="o">*</span><span class="n">zblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zAblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
			<span class="n">_np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
			<span class="n">norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">zBblock</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_k</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
			<span class="k">del</span> <span class="n">mask</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
		<span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">):</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">norm</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">norm</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

		<span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span><span class="n">norm</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">norm</span>

	<span class="c1">##### provate methods</span>

	<span class="k">def</span> <span class="nf">_check_symm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">static</span><span class="p">,</span><span class="n">dynamic</span><span class="p">,</span><span class="n">photon_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">kblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
		<span class="n">pblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
		<span class="n">zblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
		<span class="n">pzblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>
		<span class="n">zAblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
		<span class="n">zBblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks_1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
		<span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span>

		<span class="k">if</span> <span class="n">photon_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">basis_sort_opstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_opstr</span>
			<span class="n">static_list</span><span class="p">,</span><span class="n">dynamic_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_local_lists</span><span class="p">(</span><span class="n">static</span><span class="p">,</span><span class="n">dynamic</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">basis_sort_opstr</span> <span class="o">=</span> <span class="n">photon_basis</span><span class="o">.</span><span class="n">_sort_opstr</span>
			<span class="n">static_list</span><span class="p">,</span><span class="n">dynamic_list</span> <span class="o">=</span> <span class="n">photon_basis</span><span class="o">.</span><span class="n">_get_local_lists</span><span class="p">(</span><span class="n">static</span><span class="p">,</span><span class="n">dynamic</span><span class="p">)</span>


		<span class="n">static_blocks</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">dynamic_blocks</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">kblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_T</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;T symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_T</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;T symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

		<span class="k">if</span> <span class="n">pblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_P</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;P symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_P</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;P symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

		<span class="k">if</span> <span class="n">zblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_Z</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;Z/C symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_Z</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;Z/C symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">zAblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_ZA</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;ZA/CA symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_ZA</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;ZA/CA symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">zBblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_ZB</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;ZB/CB symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

			<span class="n">oddops</span><span class="p">,</span><span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_ZB</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span> <span class="ow">or</span> <span class="n">oddops</span><span class="p">:</span>
				<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;ZB/CB symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">oddops</span><span class="p">),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">pzblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_PZ</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">static_list</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">static_blocks</span><span class="p">[</span><span class="s2">&quot;PZ/PC symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

			<span class="n">missingops</span> <span class="o">=</span> <span class="n">_check</span><span class="o">.</span><span class="n">check_PZ</span><span class="p">(</span><span class="n">basis_sort_opstr</span><span class="p">,</span><span class="n">dynamic_list</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">missingops</span><span class="p">:</span>	<span class="n">dynamic_blocks</span><span class="p">[</span><span class="s2">&quot;PZ/PC symm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missingops</span><span class="p">),)</span>

		<span class="k">return</span> <span class="n">static_blocks</span><span class="p">,</span><span class="n">dynamic_blocks</span>


<span class="k">def</span> <span class="nf">_get_vec_dense</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">basis_in</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">):</span>
	<span class="n">dtype</span><span class="o">=</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">]</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
	<span class="n">kblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
	<span class="n">pblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
	<span class="n">zblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
	<span class="n">zAblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
	<span class="n">zBblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
	<span class="n">pzblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>


	<span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
	<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>	
	<span class="n">v</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">kblock</span><span class="o">*</span><span class="n">a</span><span class="o">/</span><span class="n">L</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">L</span>

	<span class="n">Ns_full</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">v_rev</span> <span class="o">=</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># access array in reverse order. </span>

	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">//</span><span class="n">a</span><span class="p">):</span>
		<span class="n">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)</span>	
		<span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
		<span class="n">vc_tran</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
		<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
		<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
		<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">v_rev</span><span class="p">[</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">vc</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">vc_tran</span> <span class="o">*=</span> <span class="n">sign</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
		
		<span class="n">ops</span><span class="o">.</span><span class="n">py_shift</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
	
	<span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_get_vec_sparse</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">basis_in</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">):</span>
	<span class="n">dtype</span><span class="o">=</span><span class="n">_dtypes</span><span class="p">[</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">]</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
	<span class="n">kblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
	<span class="n">pblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
	<span class="n">zblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
	<span class="n">zAblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
	<span class="n">zBblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
	<span class="n">pzblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


	
	<span class="k">if</span> <span class="n">ind_neg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">row_neg</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
		<span class="n">col_neg</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">col_neg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">row_neg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">col_neg</span><span class="p">))</span>
		<span class="n">col_neg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">),</span><span class="n">col_neg</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">ind_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">row_pos</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
		<span class="n">col_pos</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">col_pos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">row_pos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">col_pos</span><span class="p">))</span>
		<span class="n">col_pos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">),</span><span class="n">col_pos</span><span class="p">)</span>


	<span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>	
	<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v0</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">kblock</span><span class="o">*</span><span class="n">a</span><span class="o">/</span><span class="n">L</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">L</span>


	<span class="n">Ns_full</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">basis_in</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">//</span><span class="n">a</span><span class="p">):</span>
		<span class="n">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)</span>
		<span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
		<span class="n">data_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">data_neg</span> <span class="o">=</span> <span class="n">vc</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="c1"># view which passes into sparse matrix constructor</span>
		<span class="n">data_pos_flat</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
		<span class="n">data_neg_flat</span> <span class="o">=</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
		<span class="c1"># view which us used to multiply by sign</span>
		<span class="n">data_pos_tran</span> <span class="o">=</span> <span class="n">data_pos</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
		<span class="n">data_neg_tran</span> <span class="o">=</span> <span class="n">data_neg</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
		
		<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
		<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>

		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">index</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ns_full</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">-=</span> <span class="n">basis_in</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_pos</span><span class="p">],</span><span class="n">col_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg_flat</span><span class="p">,(</span><span class="n">index</span><span class="p">[</span><span class="n">row_neg</span><span class="p">],</span><span class="n">col_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_pos_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_neg_tran</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">v</span><span class="o">.</span><span class="n">sum_duplicates</span><span class="p">()</span>
		<span class="n">v</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
		<span class="n">ops</span><span class="o">.</span><span class="n">py_shift</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_get_proj_sparse</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">basis_in</span><span class="p">,</span><span class="n">basis_pcon</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="o">**</span><span class="n">blocks</span><span class="p">):</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
	<span class="n">kblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kblock&quot;</span><span class="p">)</span>
	<span class="n">pblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pblock&quot;</span><span class="p">)</span>
	<span class="n">zblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zblock&quot;</span><span class="p">)</span>
	<span class="n">zAblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zAblock&quot;</span><span class="p">)</span>
	<span class="n">zBblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zBblock&quot;</span><span class="p">)</span>
	<span class="n">pzblock</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pzblock&quot;</span><span class="p">)</span>


	<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">kblock</span><span class="o">*</span><span class="n">a</span><span class="o">/</span><span class="n">L</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">k</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">L</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
	<span class="n">sign</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">basis_in</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">basis_pcon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">basis_in</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">basis_pcon</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">basis_in</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="o">//</span><span class="n">a</span><span class="p">):</span>
		<span class="n">C</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">norms</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)</span>
		<span class="n">data_pos</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">data_neg</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>

		<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
		<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
		<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>


		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zAblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zAblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_A</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zBblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zBblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_sublat_B</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">zblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">zblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pzblock</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_pos</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_pos</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_pos</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">ind_neg</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">_sp</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">data_neg</span><span class="p">,(</span><span class="n">index</span><span class="p">,</span><span class="n">ind_neg</span><span class="p">)),</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_pos</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_pos</span><span class="p">]</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">pzblock</span>
			<span class="n">data_neg</span> <span class="o">*=</span> <span class="n">sign</span><span class="p">[</span><span class="n">ind_neg</span><span class="p">]</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_fliplr</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">ops</span><span class="o">.</span><span class="n">py_flip_all</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>

		<span class="n">ops</span><span class="o">.</span><span class="n">py_shift</span><span class="p">(</span><span class="n">basis_in</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">sign</span><span class="p">)</span>


	<span class="k">return</span> <span class="n">v</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">QuSpin 0.3.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Phillip Weinberg, Markus Schmitt and Marin Bukov.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.
    </div>
  </body>
</html>