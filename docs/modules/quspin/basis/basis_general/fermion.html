<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>quspin.basis.basis_general.fermion &mdash; QuSpin 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../static/css/sphinx_rtd_size.css?v=f26ae176" />
      <link rel="stylesheet" type="text/css" href="../../../../static/css/py_class_property_fix.css?v=faf79ccd" />

  
  <!--[if lt IE 9]>
    <script src="../../../../static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../static/documentation_options.js?v=8d563738"></script>
        <script src="../../../../static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            QuSpin
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">QuSpin (public API)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basis.html">Basis module (<code class="xref py py-mod docutils literal notranslate"><span class="pre">quspin.basis</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../operators.html">Operators module (<code class="xref py py-mod docutils literal notranslate"><span class="pre">quspin.operators</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools.html">Tools module (<code class="xref py py-mod docutils literal notranslate"><span class="pre">quspin.tools</span></code>)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation &amp; Use</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/installation.html#basics-of-command-line-use">Basics of command line use</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../example_scripts.html">Example scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../jupyter_notebooks.html">Jupyter notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/parallelization.html">Parallel computing support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/user_basis.html"><cite>user_basis</cite> tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bugs &amp; Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute/report_a_bug.html">Report a bug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute/ask_a_question.html">Ask a question</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">QuSpin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">quspin.basis.basis_general.fermion</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for quspin.basis.basis_general.fermion</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">quspin_extensions.basis.basis_general._basis_general_core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">spinful_fermion_basis_core_wrap</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">quspin_extensions.basis.basis_general._basis_general_core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">spinless_fermion_basis_core_wrap</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">quspin_extensions.basis.basis_general._basis_general_core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_basis_type</span><span class="p">,</span>
    <span class="n">basis_zeros</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">quspin_extensions.basis.basis_general._basis_general_core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">basis_int_to_python_int</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># ,_get_basis_index</span>
<span class="kn">from</span> <span class="nn">quspin.basis.basis_general.base_general</span> <span class="kn">import</span> <span class="n">basis_general</span><span class="p">,</span> <span class="n">_check_symm_map</span>
<span class="kn">from</span> <span class="nn">quspin.basis.base</span> <span class="kn">import</span> <span class="n">MAXPRINT</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">comb</span>


<span class="c1"># general basis for hardcore bosons/spin-1/2</span>
<div class="viewcode-block" id="spinless_fermion_basis_general">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinless_fermion_basis_general.html#quspin.basis.spinless_fermion_basis_general">[docs]</a>
<span class="k">class</span> <span class="nc">spinless_fermion_basis_general</span><span class="p">(</span><span class="n">basis_general</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs basis for spinless fermion operators for USER-DEFINED symmetries.</span>

<span class="sd">    Any unitary symmetry transformation :math:`Q` of periodicity :math:`m_Q` (:math:`Q^{m_Q}=1`) has eigenvalues :math:`\\exp(-2\\pi i q/m_Q)`, labelled by an ingeter :math:`q\\in\\{0,1,\\dots,m_Q-1\\}`. These integers :math:`q` are used to define the symmetry blocks.</span>

<span class="sd">    For instance, if :math:`Q=P` is parity (reflection), then :math:`q=0,1`. If :math:`Q=T` is translation by one lattice site, then :math:`q` labels the mometum blocks in the same fashion as for the `..._basis_1d` classes.</span>

<span class="sd">    User-defined symmetries with the `spinless_fermion_basis_general` class can be programmed as follows. Suppose we have a system of L sites, enumerated :math:`s=(s_0,s_1,\\dots,s_{L-1})`. There are two types of operations one can perform on the sites:</span>
<span class="sd">            * exchange the labels of two sites: :math:`s_i \\leftrightarrow s_j` (e.g., translation, parity)</span>
<span class="sd">            * invert the **fermion population** on a given site with appropriate sign flip (see `&quot;z&quot;` operator string) :math:`c_j^\\dagger\\to (-1)^j c_j`: :math:`s_i\\leftrightarrow -(s_j+1)` (e.g., particle-hole symmetry)</span>

<span class="sd">    These two operations already comprise a variety of symmetries, including translation, parity (reflection) and population inversion. For a specific example, see below.</span>

<span class="sd">    The supported operator strings for `spinless_fermion_basis_general` are:</span>

<span class="sd">    .. math::</span>
<span class="sd">            \\begin{array}{cccc}</span>
<span class="sd">                    \\texttt{basis}/\\texttt{opstr}   &amp;   \\texttt{&quot;I&quot;}   &amp;   \\texttt{&quot;+&quot;}   &amp;   \\texttt{&quot;-&quot;}  &amp;   \\texttt{&quot;n&quot;}   &amp;   \\texttt{&quot;z&quot;}    &amp;   \\texttt{&quot;x&quot;}    &amp;   \\texttt{&quot;y&quot;}    \\newline</span>
<span class="sd">                    \\texttt{spinless_fermion_basis_general}&amp; \\hat{1}        &amp;   \\hat c^\\dagger      &amp;       \\hat c          &amp; \\hat c^\\dagger c     &amp;  \\hat c^\\dagger\\hat c - \\frac{1}{2}  &amp;   \\hat c + \\hat c^\\dagger    &amp;   -i\\left( \\hat c - \\hat c^\\dagger\\right)   \\newline</span>
<span class="sd">            \\end{array}</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    * For particle-hole symmetry, please use exclusively the operator string `&quot;z&quot;` (see table), otherwise the automatic symmetry check will raise an error when set to `check_symm=True`.</span>
<span class="sd">    * QuSpin raises a warning to alert the reader when non-commuting symmetries are passed. In such cases, we recommend the user to manually check the combined usage of symmetries by, e.g., comparing the eigenvalues.</span>
<span class="sd">    * The fermion operator strings &quot;x&quot; and &quot;y&quot; correspond to real fermions, i.e. Majorana operators (note the sign difference between &quot;y&quot; and the :math:`\\sigma^y` Pauli matrix, which is convention).</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    The code snippet below shows how to use the `spinless_fermion_basis_general` class to construct the basis in the zero momentum sector of positive parity for the fermion Hamiltonian</span>

<span class="sd">    .. math::</span>
<span class="sd">            H=-J\\sum_{\\langle ij\\rangle} c^\\dagger_{i}c_j + \\mathrm{h.c.} - \\mu\\sum_j n_j + U \\sum_{\\langle ij\\rangle} n_{i} n_j</span>

<span class="sd">    Moreover, it demonstrates how to pass user-defined symmetries to the `boson_basis_general` constructor. In particular,</span>
<span class="sd">    we do translation invariance and parity (reflection) (along each lattice direction).</span>

<span class="sd">    .. literalinclude:: ../../doc_examples/spinless_fermion_basis_general-example.py</span>
<span class="sd">            :linenos:</span>
<span class="sd">            :language: python</span>
<span class="sd">            :lines: 7-</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="spinless_fermion_basis_general.__init__">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinless_fermion_basis_general.html#quspin.basis.spinless_fermion_basis_general.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">N</span><span class="p">,</span>
        <span class="n">Nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Ns_block_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">make_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">block_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">blocks</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intializes the `spinless_fermion_basis_general` object (basis for fermionic operators).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        L: int</span>
<span class="sd">                Length of chain/number of sites.</span>
<span class="sd">        Nf: {int,list}, optional</span>
<span class="sd">                Number of fermions in chain. Can be integer or list to specify one or more particle sectors.</span>
<span class="sd">        nf: float, optional</span>
<span class="sd">                Density of fermions in chain (fermions per site).</span>
<span class="sd">        Ns_block_est: int, optional</span>
<span class="sd">                Overwrites the internal estimate of the size of the reduced Hilbert space for the given symmetries. This can be used to help conserve memory if the exact size of the H-space is known ahead of time.</span>
<span class="sd">        make_basis: bool, optional</span>
<span class="sd">                Boolean to control whether to make the basis. Allows the use to use some functionality of the basis constructor without constructing the entire basis.</span>
<span class="sd">        block_order: list of strings, optional</span>
<span class="sd">                A list of strings containing the names of the symmetry blocks which specifies the order in which the symmetries will be applied to the state when calculating the basis. The first element in the list is applied to the state first followed by the second element, etc. If the list is not specificed the ordering is such that the symmetry with the largest cycle is the first, followed by the second largest, etc.</span>
<span class="sd">        **blocks: optional</span>
<span class="sd">                keyword arguments which pass the symmetry generator arrays. For instance:</span>

<span class="sd">                &gt;&gt;&gt; basis(...,kxblock=(Q,q),...)</span>

<span class="sd">                The keys of the symmetry sector, e.g. `kxblock`, can be chosen arbitrarily by the user. The</span>
<span class="sd">                values are tuples where the first entry contains the symmetry transformation :math:`Q` acting on the</span>
<span class="sd">                lattice sites (see class example), and the second entry is an integer :math:`q` to label the symmetry</span>
<span class="sd">                sector.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_Np</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_Np&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_Np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_Np&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot use &#39;nf&#39; and &#39;Nf&#39; simultaineously.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nf</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>

        <span class="n">basis_general</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">block_order</span><span class="o">=</span><span class="n">block_order</span><span class="p">,</span> <span class="o">**</span><span class="n">blocks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_pcon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count_particles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">_Np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count_particles</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">_Np</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_Np must be integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_Np</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_Np</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">_Np</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">_Np</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;_Np == -1 for no particle conservation, _Np &gt;= 0 for particle conservation&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">N</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_pcon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Nf</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Np_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Nf must be integer or iterable object.&quot;</span><span class="p">)</span>

            <span class="n">Nf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">_nf</span> <span class="ow">in</span> <span class="n">Nf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_nf</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">_nf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;particle number Nf must satisfy: 0 &lt;= Nf &lt;= N&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">+=</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">_nf</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pcon_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">Nf</span><span class="o">=</span><span class="n">Nf</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Ns_block_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Ns_block_est</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Ns_block_est must be integer value.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Ns_block_est</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ns_block_est must be an integer &gt; 0&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns_block_est</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span> <span class="o">=</span> <span class="n">get_basis_type</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_core</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_core_wrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sps</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ns_block_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Np</span> <span class="o">=</span> <span class="n">Nf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noncommuting_bits</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">))]</span>

        <span class="c1"># make the basis; make() is function method of base_general</span>
        <span class="k">if</span> <span class="n">make_basis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_operators</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;availible operators for ferion_basis_1d:&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">I: identity &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">+: raising operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">-: lowering operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">n: number operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">z: c-symm number operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">x: majorana x-operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">y: majorana y-operator&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_core</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_core_wrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sort_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;|&#39; character found in op: </span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;number of operators in opstr: </span><span class="si">{0}</span><span class="s2"> not equal to length of indx </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">zipstr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">zipstr</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zipstr</span><span class="p">)</span>
            <span class="n">swapped</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">anticommutes</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">swapped</span><span class="p">:</span>
                <span class="n">swapped</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
                        <span class="n">swapped</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zipstr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="s2">&quot;+&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                        <span class="p">]:</span>
                            <span class="n">anticommutes</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="n">op1</span><span class="p">,</span> <span class="n">op2</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">zipstr</span><span class="p">)</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op1</span><span class="p">)</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op2</span><span class="p">)</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">anticommutes</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_non_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="n">opstr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
            <span class="n">indx_p</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">opstr</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">indx_p</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indx_p</span><span class="p">)</span>
            <span class="n">indx_p</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">opstr</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">indx_p</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indx_p</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_hc_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="c1"># take h.c. + &lt;--&gt; - , reverse operator order , and conjugate coupling</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_sort_opstr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">op</span>
        <span class="p">)</span>  <span class="c1"># return the sorted op.</span>

    <span class="k">def</span> <span class="nf">_expand_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)]</span></div>



<span class="k">def</span> <span class="nf">process_spinful_map</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span><span class="p">:</span>
        <span class="n">i_map</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">i_map</span><span class="p">[</span><span class="nb">map</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">i_map</span><span class="p">[</span><span class="nb">map</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">N</span>  <span class="c1"># site mapping</span>
        <span class="n">adv_map</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">i_map</span><span class="p">,</span> <span class="p">(</span><span class="n">i_map</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">adv_map</span><span class="p">,</span> <span class="n">q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">,</span> <span class="n">q</span>


<span class="c1"># general basis for hardcore bosons/spin-1/2</span>
<div class="viewcode-block" id="spinful_fermion_basis_general">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general">[docs]</a>
<span class="k">class</span> <span class="nc">spinful_fermion_basis_general</span><span class="p">(</span><span class="n">spinless_fermion_basis_general</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs basis for spinful fermion operators for USER-DEFINED symmetries.</span>

<span class="sd">    Any unitary symmetry transformation :math:`Q` of periodicity :math:`m_Q` (:math:`Q^{m_Q}=1`) has eigenvalues :math:`\\exp(-2\\pi i q/m_Q)`, labelled by an ingeter :math:`q\\in\\{0,1,\\dots,m_Q-1\\}`. These integers :math:`q` are used to define the symmetry blocks.</span>

<span class="sd">    For instance, if :math:`Q=P` is parity (reflection), then :math:`q=0,1`. If :math:`Q=T` is translation by one lattice site, then :math:`q` labels the mometum blocks in the same fashion as for the `..._basis_1d` classes.</span>

<span class="sd">    User-defined symmetries with the `spinful_fermion_basis_general` class can be programmed in two equivalent ways: *simple* and *advanced*.</span>
<span class="sd">            * *simple* symmetry definition (see optional argument `simple_symm`) uses the pipe symbol, &quot;|&quot;, in the operator string (see site-coupling lists in example below) to distinguish between the spin-up and spin-down species. Suppose we have a system of L sites. In the *simple* case, the lattice sites are enumerated :math:`s=(s_0,s_1,\\dots,s_{L-1})` for **both** spin-up and spin-down. There are two types of operations one can perform on the sites:</span>
<span class="sd">                    * exchange the labels of two sites: :math:`s_i \\leftrightarrow s_j` (e.g., translation, parity)</span>
<span class="sd">                    * invert the **fermion spin** on a given site: :math:`s_i\\leftrightarrow -(s_j+1)` (e.g., fermion spin inversion)</span>

<span class="sd">            * *advanced* symmetry definition (see optional argument `simple_symm`) does NOT use any pipe symbol in the operator string to distinguish between the spin-up and spin-down species. In the *advanced* case, the sites are enumerated :math:`s=(s_0,s_1,\\dots,s_{L-1}; s_{L},s_{L+1},\\dots,s_{2L-1})`, where the first L sites label spin-up, and the last L sites -- spin-down. There are two types of operations one can perform on the sites:</span>
<span class="sd">                    * exchange the labels of two sites: :math:`s_i \\leftrightarrow s_j` (e.g., translation, parity, fermion spin inversion)</span>
<span class="sd">                    * invert the **fermion population** on a given site with appropriate sign flip (see `&quot;z&quot;` operator string) :math:`c_j^\\dagger\\to (-1)^j c_j`: :math:`s_i\\leftrightarrow -(s_j+1)` (e.g., particle-hole symmetry)</span>


<span class="sd">    These two operations already comprise a variety of symmetries, including translation, parity (reflection), fermion-spin inversion and particle-hole like symmetries. For specific examples, see below.</span>

<span class="sd">    The supported operator strings for `spinful_fermion_basis_general` are:</span>

<span class="sd">    .. math::</span>
<span class="sd">            \\begin{array}{cccc}</span>
<span class="sd">                    \\texttt{basis}/\\texttt{opstr}   &amp;   \\texttt{&quot;I&quot;}   &amp;   \\texttt{&quot;+&quot;}   &amp;   \\texttt{&quot;-&quot;}  &amp;   \\texttt{&quot;n&quot;}   &amp;   \\texttt{&quot;z&quot;}    &amp;   \\texttt{&quot;x&quot;}    &amp;   \\texttt{&quot;y&quot;}    \\newline</span>
<span class="sd">                    \\texttt{spinful_fermion_basis_general}&amp; \\hat{1}        &amp;   \\hat c^\\dagger      &amp;       \\hat c          &amp; \\hat c^\\dagger c     &amp;  \\hat c^\\dagger\\hat c - \\frac{1}{2}  &amp;   \\hat c + \\hat c^\\dagger    &amp;   -i\\left( \\hat c - \\hat c^\\dagger\\right)   \\newline</span>
<span class="sd">            \\end{array}</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    * The definition of the operation :math:`s_i\\leftrightarrow -(s_j+1)` **differs** for the *simple* and *advanced* cases.</span>
<span class="sd">    * For particle-hole symmetry, please use exclusively the operator string `&quot;z&quot;` (see table), otherwise the automatic symmetry check will raise an error when set to `check_symm=True`.</span>
<span class="sd">    * QuSpin raises a warning to alert the reader when non-commuting symmetries are passed. In such cases, we recommend the user to manually check the combined usage of symmetries by, e.g., comparing the eigenvalues.</span>
<span class="sd">    * The fermion operator strings &quot;x&quot; and &quot;y&quot; correspond to real fermions, i.e. Majorana operators (note the sign difference between &quot;y&quot; and the :math:`\\sigma^y` Pauli matrix, which is convention).</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    The code snippets below show how to construct the two-dimensional Fermi-Hubbard model with onsite interactions.</span>

<span class="sd">    .. math::</span>
<span class="sd">            H = -J \\sum_{\\langle ij\\rangle,\\sigma} c^\\dagger_{i\\sigma}c_{j\\sigma} + \\mathrm{h.c.} - \\mu\\sum_{j,\\sigma} n_{j\\sigma} + U\\sum_j n_{j\\uparrow} n_{j\\downarrow}</span>

<span class="sd">    The first code snippet demonstrates how to pass **simple** user-defined symmetries to the `spinful_fermion_basis_general` constructor. In particular,</span>
<span class="sd">    we do translation invariance and fermion spin inversion.</span>

<span class="sd">    .. literalinclude:: ../../doc_examples/spinful_fermion_basis_general-simple-example.py</span>
<span class="sd">            :linenos:</span>
<span class="sd">            :language: python</span>
<span class="sd">            :lines: 7-</span>

<span class="sd">    The second code snippet demonstrates how to pass **advanced** user-defined symmetries to the `spinful_fermion_basis_general` constructor. Like above,</span>
<span class="sd">    we do translation invariance and fermion spin inversion.</span>

<span class="sd">    .. literalinclude:: ../../doc_examples/spinful_fermion_basis_general-adv-example.py</span>
<span class="sd">            :linenos:</span>
<span class="sd">            :language: python</span>
<span class="sd">            :lines: 7-</span>

<span class="sd">    The third code snippet demonstrates how to pass **advanced** user-defined particle-hole symemtry to the `spinful_fermion_basis_general` constructor with translational invariance.</span>

<span class="sd">    .. literalinclude:: ../../doc_examples/spinful_fermion_basis_general-adv_ph-example.py</span>
<span class="sd">            :linenos:</span>
<span class="sd">            :language: python</span>
<span class="sd">            :lines: 7-</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.__init__">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">N</span><span class="p">,</span>
        <span class="n">Nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Ns_block_est</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">simple_symm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">make_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">block_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">double_occupancy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">blocks</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intializes the `spinful_fermion_basis_general` object (basis for fermionic operators).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        L: int</span>
<span class="sd">                Length of chain/number of sites.</span>
<span class="sd">        Nf: tuple(int), optional</span>
<span class="sd">                Number of fermions in chain. Can be tupe of integers or list of tuples of integers `[(Nup,Ndown),...]` to specify one or more particle sectors.</span>
<span class="sd">        nf: float, optional</span>
<span class="sd">                Density of fermions in chain (fermions per site).</span>
<span class="sd">        Ns_block_est: int, optional</span>
<span class="sd">                Overwrites the internal estimate of the size of the reduced Hilbert space for the given symmetries. This can be used to help conserve memory if the exact size of the H-space is known ahead of time.</span>
<span class="sd">        simple_symm: bool, optional</span>
<span class="sd">                Flags whidh toggles the setting for the types of mappings and operator strings the basis will use. See this tutorial for more details.</span>
<span class="sd">        make_basis: bool, optional</span>
<span class="sd">                Boolean to control whether to make the basis. Allows the use to use some functionality of the basis constructor without constructing the entire basis.</span>
<span class="sd">        double_occupancy: bool, optional</span>
<span class="sd">                Boolean to toggle the presence of doubly-occupied sites (both a spin up and a spin-down fermion present on the same lattice site) in the basis. Default is `double_occupancy=True`, for which doubly-occupied states are present.</span>
<span class="sd">        block_order: list of strings, optional</span>
<span class="sd">                A list of strings containing the names of the symmetry blocks which specifies the order in which the symmetries will be applied to the state when calculating the basis. The first element in the list is applied to the state first followed by the second element, etc. If the list is not specificed the ordering is such that the symmetry with the largest cycle is the first, followed by the second largest, etc.</span>
<span class="sd">        **blocks: optional</span>
<span class="sd">                keyword arguments which pass the symmetry generator arrays. For instance:</span>

<span class="sd">                &gt;&gt;&gt; basis(...,kxblock=(Q,q),...)</span>

<span class="sd">                The keys of the symmetry sector, e.g. `kxblock`, can be chosen arbitrarily by the user. The</span>
<span class="sd">                values are tuples where the first entry contains the symmetry transformation :math:`Q` acting on the</span>
<span class="sd">                lattice sites (see class example), and the second entry is an integer :math:`q` to label the symmetry</span>
<span class="sd">                sector.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Nf = [(Nup,Ndown),...]</span>
        <span class="c1"># Nup is left side of basis sites 0 - N-1</span>
        <span class="c1"># Ndown is right side of basis sites N - 2*N-1</span>

        <span class="n">_Np</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_Np&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_Np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_Np&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot use &#39;nf&#39; and &#39;Nf&#39; simultaineously.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nf</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;blocks must contain tuple: (map,q).&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span> <span class="o">=</span> <span class="n">simple_symm</span>

        <span class="k">if</span> <span class="n">simple_symm</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">N</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Simple symmetries must have mapping of length N.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Advanced symmetries must have mapping of length 2*N.&quot;</span><span class="p">)</span>

        <span class="n">new_blocks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">process_spinful_map</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="o">*</span><span class="n">item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="n">blocks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_blocks</span><span class="p">)</span>

        <span class="n">basis_general</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">block_order</span><span class="o">=</span><span class="n">block_order</span><span class="p">,</span> <span class="o">**</span><span class="n">blocks</span><span class="p">)</span>
        <span class="c1"># self._check_pcon = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count_particles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">_Np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count_particles</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">_Np</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_Np must be integer&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_Np</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_Np</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">Nf</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="n">Nf</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">_Np</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_Np</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">Nf</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="n">Nf</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;_Np == -1 for no particle conservation, _Np &gt;= 0 for particle conservation&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">Nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">N</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_proj_pcon</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">Nup</span><span class="p">,</span> <span class="n">Ndown</span> <span class="o">=</span> <span class="n">Nf</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Nup</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">Ndown</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Nup</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ndown</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Nf must be tuple of integers or iterable object of tuples.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="p">[</span><span class="n">Nf</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Nf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">Nf</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Nf must be tuple of integers or iterable object of tuples.&quot;</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">Nup</span><span class="p">,</span> <span class="n">Ndown</span> <span class="ow">in</span> <span class="n">Nf</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">Nup</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">Nup</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;particle numbers in Nf must satisfy: 0 &lt;= n &lt;= N&quot;</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">Ndown</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">Ndown</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;particle numbers in Nf must satisfy: 0 &lt;= n &lt;= N&quot;</span>
                            <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">+=</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Nup</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span>
                            <span class="n">N</span><span class="p">,</span> <span class="n">Ndown</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Nf_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Nf must be tuple of integers or iterable object of tuples.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">Nf</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Nf must be tuple of integers or iterable object of tuples.&quot;</span>
                    <span class="p">)</span>

                <span class="n">Nf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">Nup</span><span class="p">,</span> <span class="n">Ndown</span> <span class="ow">in</span> <span class="n">Nf</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Nup</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">Nup</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;particle numbers in Nf must satisfy: 0 &lt;= n &lt;= N&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">Ndown</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">Ndown</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;particle numbers in Nf must satisfy: 0 &lt;= n &lt;= N&quot;</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">+=</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Nup</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">comb</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Ndown</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pcon_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">Nf</span><span class="o">=</span><span class="n">Nf</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">double_occupancy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Ns_block_est</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Ns_block_est</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Ns_block_est must be integer value.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Ns_block_est</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ns_block_est must be an integer &gt; 0&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="n">Ns_block_est</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span> <span class="o">=</span> <span class="n">get_basis_type</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_core</span> <span class="o">=</span> <span class="n">spinful_fermion_basis_core_wrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qs</span><span class="p">,</span> <span class="n">double_occupancy</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sps</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ns_block_est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Np</span> <span class="o">=</span> <span class="n">Nf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_double_occupancy</span> <span class="o">=</span> <span class="n">double_occupancy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noncommuting_bits</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int8</span><span class="p">))]</span>

        <span class="c1"># make the basis; make() is function method of base_general</span>
        <span class="k">if</span> <span class="n">make_basis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis</span> <span class="o">=</span> <span class="n">basis_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_operators</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;availible operators for ferion_basis_1d:&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">I: identity &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">+: raising operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">-: lowering operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">n: number operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">z: c-symm number operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">x: majorana x-operator&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">y: majorana y-operator&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allowed_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_core</span> <span class="o">=</span> <span class="n">spinful_fermion_basis_core_wrap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basis_dtype</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_double_occupancy</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">#################################################</span>
    <span class="c1"># override for _inplace_Op and Op_shift_sector. #</span>
    <span class="c1">#################################################</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.ent_entropy">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.ent_entropy">[docs]</a>
    <span class="k">def</span> <span class="nf">ent_entropy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">sub_sys_A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">subsys_ordering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_rdm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enforce_pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_rdm_EVs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">sparse_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">svd_solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">svd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates entanglement entropy of subsystem A and the corresponding reduced density matrix</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Algorithm is based on both partial tracing and sigular value decomposition (SVD), optimised for speed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : obj</span>
<span class="sd">                State of the quantum system. Can be either one of:</span>

<span class="sd">                        * numpy.ndarray [shape (Ns,)]: pure state (default).</span>
<span class="sd">                        * numpy.ndarray [shape (Ns,Ns)]: density matrix (DM).</span>
<span class="sd">                        * dict(&#39;V_states&#39;,V_states) [shape (Ns,Nvecs)]: collection of `Nvecs` states stored in the columns of `V_states`.</span>
<span class="sd">        sub_sys_A : tuple/list, optional</span>
<span class="sd">                Defines the sites contained in subsystem A [by python convention the first site of the chain is labelled j=0]. Depending on the usage of simple/advanced notations the input is different:</span>

<span class="sd">                        * Simple notation: The format is `(spin_up_subsys,spin_down_subsys)` where the tuple `spin_up_subsys` and `spin_down_subsys` are lists (see example below).  Default is `tuple(range(N//2),range(N//2))` with `N` the number of physical lattice sites (e.g. sites which both species of fermions can occupy).</span>
<span class="sd">                        * Advanced notation: The format is a list, the labeling of the up spins are sites `0 - (N-1)` while the down spins are on sites `N - (2N - 1)`.</span>
<span class="sd">        return_rdm : str, optional</span>
<span class="sd">                Toggles returning the reduced DM. Can be tierh one of:</span>

<span class="sd">                        * &quot;A&quot;: returns reduced DM of subsystem A.</span>
<span class="sd">                        * &quot;B&quot;: returns reduced DM of subsystem B.</span>
<span class="sd">                        * &quot;both&quot;: returns reduced DM of both A and B subsystems.</span>
<span class="sd">        enforce_pure : bool, optional</span>
<span class="sd">                Whether or not to assume `state` is a colelction of pure states or a mixed density matrix, if</span>
<span class="sd">                it is a square array. Default is `False`.</span>
<span class="sd">        subsys_ordering : bool, optional</span>
<span class="sd">                Whether or not to reorder the sites in `sub_sys_A` in ascending order. Default is `True`.</span>
<span class="sd">        sparse : bool, optional</span>
<span class="sd">                Whether or not to return a sparse DM. Default is `False`.</span>
<span class="sd">        return_rdm_EVs : bool, optional</span>
<span class="sd">                Whether or not to return the eigenvalues of rthe educed DM. If `return_rdm` is specified,</span>
<span class="sd">                the eigenvalues of the corresponding DM are returned. If `return_rdm` is NOT specified,</span>
<span class="sd">                the spectrum of `rdm_A` is returned by default. Default is `False`.</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">                Renyi :math:`\\alpha` parameter for the entanglement entropy. Default is :math:`\\alpha=1`:</span>

<span class="sd">                .. math::</span>
<span class="sd">                        S_\\mathrm{ent}(\\alpha) =  \\frac{1}{1-\\alpha}\\log \\mathrm{tr}_{A} \\left( \\mathrm{tr}_{A^c} \\vert\\psi\\rangle\\langle\\psi\\vert \\right)^\\alpha</span>

<span class="sd">                **Note:** The logarithm used is the natural logarithm (base e).</span>
<span class="sd">        sparse_diag : bool, optional</span>
<span class="sd">                When `sparse=True`, this flag enforces the use of</span>
<span class="sd">                `scipy.sparse.linalg.eigsh() &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.linalg.eigsh.html&gt;`_</span>
<span class="sd">                to calculate the eigenvaues of the reduced DM.</span>
<span class="sd">        maxiter : int, optional</span>
<span class="sd">                Specifies the number of iterations for Lanczos diagonalisation. Look up documentation for</span>
<span class="sd">                `scipy.sparse.linalg.eigsh() &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.linalg.eigsh.html&gt;`_.</span>
<span class="sd">        svd_solver : object, optional</span>
<span class="sd">                Specifies the svd solver to be used, e.g. `numpy.linalg.svd` or `scipy.linalg.svd`, or a custom solver. Effective when `enforce_pure=True` or `sparse=False`.</span>
<span class="sd">        svd_kwargs : dict, optional</span>
<span class="sd">                Specifies additional arguments for `svd_solver`.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">                Dictionary with following keys, depending on input parameters:</span>
<span class="sd">                        * &quot;Sent_A&quot;: entanglement entropy of subsystem A (default).</span>
<span class="sd">                        * &quot;Sent_B&quot;: entanglement entropy of subsystem B.</span>
<span class="sd">                        * &quot;p_A&quot;: singular values of reduced DM of subsystem A (default).</span>
<span class="sd">                        * &quot;p_B&quot;: singular values of reduced DM of subsystem B.</span>
<span class="sd">                        * &quot;rdm_A&quot;: reduced DM of subsystem A.</span>
<span class="sd">                        * &quot;rdm_B&quot;: reduced DM of subsystem B.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; sub_sys_A_up=range(basis.L//2) # subsystem for spin-up fermions</span>
<span class="sd">        &gt;&gt;&gt; sub_sys_A_down=range(basis.L//2+1) # subsystem for spin-down fermions</span>
<span class="sd">        &gt;&gt;&gt; subsys_A=(sub_sys_A_up,sub_sys_A_down)</span>
<span class="sd">        &gt;&gt;&gt; state=1.0/np.sqrt(basis.Ns)*np.ones(basis.Ns) # infinite temperature state</span>
<span class="sd">        &gt;&gt;&gt; ent_entropy(state,sub_sys_A=subsys_A,return_rdm=&quot;A&quot;,enforce_pure=False,return_rdm_EVs=False,</span>
<span class="sd">        &gt;&gt;&gt;				sparse=False,alpha=1.0,sparse_diag=True,subsys_ordering=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub_sys_A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sub_sys_A</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_sites</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_sites</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sub_sys_A</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_sys_A</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;sub_sys_A must be a tuple which contains the subsystems for the up spins in the </span><span class="se">\</span>
<span class="s2">								  first (left) part of the tuple and the down spins in the last (right) part of the tuple.&quot;</span>
                <span class="p">)</span>

            <span class="n">sub_sys_A_up</span><span class="p">,</span> <span class="n">sub_sys_A_down</span> <span class="o">=</span> <span class="n">sub_sys_A</span>

            <span class="n">sub_sys_A</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sub_sys_A_up</span><span class="p">)</span>
            <span class="n">sub_sys_A</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="n">N_sites</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub_sys_A_down</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub_sys_A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sub_sys_A</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sites</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">N_sites</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sites</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">]</span>

        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_ent_entropy</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">sub_sys_A</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span>
            <span class="n">subsys_ordering</span><span class="o">=</span><span class="n">subsys_ordering</span><span class="p">,</span>
            <span class="n">return_rdm</span><span class="o">=</span><span class="n">return_rdm</span><span class="p">,</span>
            <span class="n">enforce_pure</span><span class="o">=</span><span class="n">enforce_pure</span><span class="p">,</span>
            <span class="n">return_rdm_EVs</span><span class="o">=</span><span class="n">return_rdm_EVs</span><span class="p">,</span>
            <span class="n">sparse</span><span class="o">=</span><span class="n">sparse</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">sparse_diag</span><span class="o">=</span><span class="n">sparse_diag</span><span class="p">,</span>
            <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
            <span class="n">svd_solver</span><span class="o">=</span><span class="n">svd_solver</span><span class="p">,</span>
            <span class="n">svd_kwargs</span><span class="o">=</span><span class="n">svd_kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_Op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">((</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_Op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inplace_Op</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">v_in</span><span class="p">,</span>
        <span class="n">op_list</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">,</span>
        <span class="n">transposed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">conjugated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">v_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">a</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">new_op_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span> <span class="ow">in</span> <span class="n">op_list</span><span class="p">:</span>
                <span class="n">new_opstr</span><span class="p">,</span> <span class="n">new_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">((</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>
                <span class="n">new_op_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_opstr</span><span class="p">,</span> <span class="n">new_indx</span><span class="p">,</span> <span class="n">J</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_op_list</span> <span class="o">=</span> <span class="n">op_list</span>

        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_inplace_Op</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">v_in</span><span class="p">,</span>
            <span class="n">new_op_list</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">,</span>
            <span class="n">transposed</span><span class="o">=</span><span class="n">transposed</span><span class="p">,</span>
            <span class="n">conjugated</span><span class="o">=</span><span class="n">conjugated</span><span class="p">,</span>
            <span class="n">v_out</span><span class="o">=</span><span class="n">v_out</span><span class="p">,</span>
            <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.Op_shift_sector">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.Op_shift_sector">[docs]</a>
    <span class="k">def</span> <span class="nf">Op_shift_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_basis</span><span class="p">,</span> <span class="n">op_list</span><span class="p">,</span> <span class="n">v_in</span><span class="p">,</span> <span class="n">v_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">new_op_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span> <span class="ow">in</span> <span class="n">op_list</span><span class="p">:</span>
                <span class="n">new_opstr</span><span class="p">,</span> <span class="n">new_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">((</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>
                <span class="n">new_op_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_opstr</span><span class="p">,</span> <span class="n">new_indx</span><span class="p">,</span> <span class="n">J</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_op_list</span> <span class="o">=</span> <span class="n">op_list</span>

        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">Op_shift_sector</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">other_basis</span><span class="p">,</span> <span class="n">new_op_list</span><span class="p">,</span> <span class="n">v_in</span><span class="p">,</span> <span class="n">v_out</span><span class="o">=</span><span class="n">v_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
        <span class="p">)</span></div>


    <span class="n">Op_shift_sector</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">Op_shift_sector</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.index">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.index">[docs]</a>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">up_state</span><span class="p">,</span> <span class="n">down_state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the index of user-defined Fock state in spinful fermion basis.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Particularly useful for defining initial Fock states through a unit vector in the direction specified</span>
<span class="sd">        by `index()`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        up_state : str</span>
<span class="sd">                string which define the Fock state for the spin up fermions.</span>

<span class="sd">        down_state : str</span>
<span class="sd">                string which define the Fock state for the spin down fermions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">                Position of the Fock state in the `spinful_fermion_basis_1d`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; s_up = &quot;&quot;.join(&quot;1&quot; for i in range(2)) + &quot;&quot;.join(&quot;0&quot; for i in range(2))</span>
<span class="sd">        &gt;&gt;&gt; s_down = &quot;&quot;.join(&quot;0&quot; for i in range(2)) + &quot;&quot;.join(&quot;1&quot; for i in range(2))</span>
<span class="sd">        &gt;&gt;&gt; print( basis.index(s_up,s_down) )</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">up_state</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">up_state</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">up_state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">up_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;up_state must be integer or string.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">down_state</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">down_state</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">down_state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">down_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;down_state must be integer or string.&quot;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">down_state</span> <span class="o">+</span> <span class="p">(</span><span class="n">up_state</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># self.N here counts 2N sites</span>

        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="spinful_fermion_basis_general.int_to_state">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.int_to_state">[docs]</a>
    <span class="k">def</span> <span class="nf">int_to_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">bracket_notation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">basis_int_to_python_int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">n_space</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
            <span class="n">bits_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">s_str_up</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">{:1d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">bits_up</span><span class="p">)</span>

            <span class="n">bits_down</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">s_str_down</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">{:1d}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">bits_down</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">left_bits_up</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">right_bits_up</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sps</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">str_list_up</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;{:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">left_bits_up</span>
            <span class="p">]</span>
            <span class="n">str_list_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="n">str_list_up</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;{:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">right_bits_up</span>
            <span class="p">)</span>
            <span class="n">s_str_up</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list_up</span><span class="p">)</span>

            <span class="n">left_bits_down</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sps</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">right_bits_down</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sps</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sps</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">str_list_down</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;{:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">left_bits_down</span>
            <span class="p">]</span>
            <span class="n">str_list_down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="n">str_list_down</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;{:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_space</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">right_bits_down</span>
            <span class="p">)</span>
            <span class="n">s_str_down</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list_down</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bracket_notation</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">s_str_up</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">s_str_down</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">s_str_up</span> <span class="o">+</span> <span class="n">s_str_down</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


    <span class="n">int_to_state</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">int_to_state</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.state_to_int">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.state_to_int">[docs]</a>
    <span class="k">def</span> <span class="nf">state_to_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">up_state</span><span class="p">,</span> <span class="n">down_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">basis_int_to_python_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">up_state</span><span class="p">,</span> <span class="n">down_state</span><span class="p">)])</span></div>


    <span class="n">state_to_int</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">state_to_int</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="spinful_fermion_basis_general.Op_bra_ket">
<a class="viewcode-back" href="../../../../generated/quspin.basis.spinful_fermion_basis_general.html#quspin.basis.spinful_fermion_basis_general.Op_bra_ket">[docs]</a>
    <span class="k">def</span> <span class="nf">Op_bra_ket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ket_states</span><span class="p">,</span> <span class="n">reduce_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">((</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ket_states=_np.array(ket_states,dtype=self._basis.dtype,ndmin=1)</span>

<span class="sd">		if len(opstr) != len(indx):</span>
<span class="sd">			raise ValueError(&#39;length of opstr does not match length of indx&#39;)</span>

<span class="sd">		if _np.any(indx &gt;= self._N) or _np.any(indx &lt; 0):</span>
<span class="sd">			raise ValueError(&#39;values in indx falls outside of system&#39;)</span>

<span class="sd">		extra_ops = set(opstr) - self._allowed_ops</span>
<span class="sd">		if extra_ops:</span>
<span class="sd">			raise ValueError(&quot;unrecognized characters {} in operator string.&quot;.format(extra_ops))</span>

<span class="sd">	</span>
<span class="sd">		bra = _np.zeros_like(ket_states) # row</span>
<span class="sd">		ME = _np.zeros(ket_states.shape[0],dtype=dtype)</span>

<span class="sd">		self._core.op_bra_ket(ket_states,bra,ME,opstr,indx,J,self._Np)</span>
<span class="sd">		</span>
<span class="sd">		if reduce_output: </span>
<span class="sd">			# remove nan&#39;s matrix elements</span>
<span class="sd">			mask = _np.logical_not(_np.logical_or(_np.isnan(ME),_np.abs(ME)==0.0))</span>
<span class="sd">			bra = bra[mask]</span>
<span class="sd">			ket_states = ket_states[mask]</span>
<span class="sd">			ME = ME[mask]</span>
<span class="sd">		else:</span>
<span class="sd">			mask = _np.isnan(ME)</span>
<span class="sd">			ME[mask] = 0.0</span>

<span class="sd">		return ME,bra,ket_states</span>
<span class="sd">		&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">Op_bra_ket</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ket_states</span><span class="p">,</span> <span class="n">reduce_output</span><span class="o">=</span><span class="n">reduce_output</span>
        <span class="p">)</span></div>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	def _get_state(self,b):</span>
<span class="sd">		b = int(b)</span>
<span class="sd">		bits_left = ((b&gt;&gt;(self.N-i-1))&amp;1 for i in range(self.N//2))</span>
<span class="sd">		state_left = &quot;|&quot;+(&quot; &quot;.join((&quot;{:1d}&quot;).format(bit) for bit in bits_left))+&quot;&gt;&quot;</span>
<span class="sd">		bits_right = ((b&gt;&gt;(self.N//2-i-1))&amp;1 for i in range(self.N//2))</span>
<span class="sd">		state_right = &quot;|&quot;+(&quot; &quot;.join((&quot;{:1d}&quot;).format(bit) for bit in bits_right))+&quot;&gt;&quot;</span>
<span class="sd">		return state_left+state_right</span>
<span class="sd">	&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_sort_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">opstr</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;missing &#39;|&#39; charactor in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;only one &#39;|&#39; charactor allowed in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;number of indices doesn&#39;t match opstr in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">indx_left</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indx_right</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

            <span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_left</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx_left</span><span class="p">)</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">op2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_right</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx_right</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_sort_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op1</span><span class="p">)</span>
            <span class="n">op2</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_sort_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span>

            <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">op1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">op2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_sort_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hc_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">opstr</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;missing &#39;|&#39; charactor in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;only one &#39;|&#39; charactor allowed in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;number of indices doesn&#39;t match opstr in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">indx_left</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indx_right</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

            <span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

            <span class="n">n_left</span> <span class="o">=</span> <span class="n">opstr_left</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">opstr_left</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">n_right</span> <span class="o">=</span> <span class="n">opstr_right</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">opstr_right</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_left</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx_left</span><span class="p">)</span>

            <span class="n">op2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_right</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx_right</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_hc_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op1</span><span class="p">)</span>
            <span class="n">op2</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_hc_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span>

            <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n_left</span> <span class="o">*</span> <span class="n">n_right</span><span class="p">))</span> <span class="o">*</span> <span class="n">op1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">op2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_hc_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_non_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">opstr</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;missing &#39;|&#39; charactor in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;only one &#39;|&#39; charactor allowed in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;number of indices doesn&#39;t match opstr in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">indx_left</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indx_right</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

            <span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_left</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx_left</span>

            <span class="n">op2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_right</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx_right</span>

            <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_non_zero</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">op1</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_non_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_non_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_simple_to_adv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">op</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;missing &#39;|&#39; charactor in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
        <span class="n">indx_left</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">indx_right</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">j</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">:]])</span>

        <span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span><span class="p">])</span>
        <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indx_left</span> <span class="o">+</span> <span class="n">indx_right</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expand_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">opstr</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;only one &#39;|&#39; charactor allowed in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">opstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;number of indices doesn&#39;t match opstr in: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">opstr</span><span class="p">,</span> <span class="n">indx</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">indx_left</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indx_right</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

            <span class="n">opstr_left</span><span class="p">,</span> <span class="n">opstr_right</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>

            <span class="n">op1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_left</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx_left</span>
            <span class="n">op1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">op2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opstr_right</span>
            <span class="n">op2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx_right</span>

            <span class="n">op1_list</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_expand_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
            <span class="n">op2_list</span> <span class="o">=</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_expand_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op2</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

            <span class="n">op_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">new_op1</span> <span class="ow">in</span> <span class="n">op1_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">new_op2</span> <span class="ow">in</span> <span class="n">op2_list</span><span class="p">:</span>
                    <span class="n">new_op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_op1</span><span class="p">)</span>
                    <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">new_op1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_op2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_op2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">new_op2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">op_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>

            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">op_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_expand_opstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_symm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">dynamic</span><span class="p">,</span> <span class="n">photon_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">photon_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basis_sort_opstr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">op</span><span class="p">:</span> <span class="n">spinless_fermion_basis_general</span><span class="o">.</span><span class="n">_sort_opstr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">op</span>
            <span class="p">)</span>
            <span class="n">static_list</span><span class="p">,</span> <span class="n">dynamic_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_local_lists</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">dynamic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basis_sort_opstr</span> <span class="o">=</span> <span class="n">photon_basis</span><span class="o">.</span><span class="n">_sort_opstr</span>
            <span class="n">static_list</span><span class="p">,</span> <span class="n">dynamic_list</span> <span class="o">=</span> <span class="n">photon_basis</span><span class="o">.</span><span class="n">_get_local_lists</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">dynamic</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_symm</span><span class="p">:</span>
            <span class="n">static_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">static_list</span><span class="p">]</span>
            <span class="n">dynamic_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_simple_to_adv</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">dynamic_list</span><span class="p">]</span>

        <span class="n">static_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dynamic_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="nb">map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">block</span> <span class="o">+</span> <span class="s2">&quot; symm&quot;</span>
            <span class="n">odd_ops</span><span class="p">,</span> <span class="n">missing_ops</span> <span class="o">=</span> <span class="n">_check_symm_map</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">basis_sort_opstr</span><span class="p">,</span> <span class="n">static_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">odd_ops</span> <span class="ow">or</span> <span class="n">missing_ops</span><span class="p">:</span>
                <span class="n">static_blocks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">odd_ops</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">missing_ops</span><span class="p">))</span>

            <span class="n">odd_ops</span><span class="p">,</span> <span class="n">missing_ops</span> <span class="o">=</span> <span class="n">_check_symm_map</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">basis_sort_opstr</span><span class="p">,</span> <span class="n">dynamic_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">odd_ops</span> <span class="ow">or</span> <span class="n">missing_ops</span><span class="p">:</span>
                <span class="n">dynamic_blocks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">odd_ops</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">missing_ops</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">static_blocks</span><span class="p">,</span> <span class="n">dynamic_blocks</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Phillip Weinberg, Markus Schmitt, and Marin Bukov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6885KZ7NH6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6885KZ7NH6', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>